{{ if has .osid (list "linux-debian" "linux-ubuntu") -}}
#!/usr/bin/env bash
set -euo pipefail

readonly ELEVATE_PREFIX=$([ "$EUID" -ne 0 ] && echo "sudo")

$ELEVATE_PREFIX apt update
$ELEVATE_PREFIX apt install -y curl gnupg apt-transport-https

log() {
  echo "--- $1" >&2
}

# Add a GPG key for an APT repository from a URL.
# $1: URL of the GPG key.
# $2: Full path for the output GPG keyring file.
add_apt_key() {
  local url="$1"
  local keyring_path="$2"
  log "Adding APT key from $url"
  $ELEVATE_PREFIX mkdir -p "$(dirname "$keyring_path")"
  curl -fsSL "$url" | $ELEVATE_PREFIX gpg --dearmor --output "$keyring_path"
}

# Add an APT repository source file.
# $1: The content of the repository line (e.g., "deb [signed-by=...] ...").
# $2: The name of the file to create in /etc/apt/sources.list.d/.
add_apt_source() {
  local repo_entry="$1"
  local list_file="$2"
  log "Adding APT source to /etc/apt/sources.list.d/$list_file"
  echo "$repo_entry" | $ELEVATE_PREFIX tee "/etc/apt/sources.list.d/$list_file"
}

# for 1Password
add_apt_key "https://downloads.1password.com/linux/keys/1password.asc" "/usr/share/keyrings/1password-archive-keyring.gpg"
add_apt_source "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" "1password.list"
$ELEVATE_PREFIX mkdir -p /etc/debsig/policies/AC2D62742012EA22
curl -fsSL https://downloads.1password.com/linux/debian/debsig/1password.pol | \
  $ELEVATE_PREFIX tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
add_apt_key "https://downloads.1password.com/linux/keys/1password.asc" "/usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg"

# for carapace-bin
add_apt_source "deb [trusted=yes] https://apt.fury.io/rsteube/ /" "fury-rsteube.list"

# for eza
add_apt_key "https://raw.githubusercontent.com/eza-community/eza/main/deb.asc" "/etc/apt/keyrings/gierens.gpg"
add_apt_source "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" "gierens.list"

# for node (from nodesource)
curl -fsSL https://deb.nodesource.com/setup_current.x | \
  $ELEVATE_PREFIX $([ "$EUID" -ne 0 ] && echo "-E") bash -

# for nushell
add_apt_key "https://apt.fury.io/nushell/gpg.key" "/etc/apt/keyrings/fury-nushell.gpg"
add_apt_source "deb [signed-by=/etc/apt/keyrings/fury-nushell.gpg] https://apt.fury.io/nushell/ /" "fury-nushell.list"

# for q (dns client)
add_apt_key "https://repo.natesales.net/apt/gpg.key" "/etc/apt/keyrings/natesales.gpg"
add_apt_source "deb [signed-by=/etc/apt/keyrings/natesales.gpg] https://repo.natesales.net/apt * *" "natesales.list"

# for vscode-insiders
add_apt_key "https://packages.microsoft.com/keys/microsoft.asc" "/etc/apt/keyrings/packages.microsoft.gpg"
add_apt_source "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" "vscode.list"

{{end -}}