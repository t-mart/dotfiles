#!/usr/bin/env bash
set -euo pipefail

# Run weekly. Current week: {{ div now.YearDay 7 }}, {{ now.Year }}

# PNPM installer freaks out if this is not set
export SHELL=bash

# Run unix-command installations
{{ $packages := joinPath .chezmoi.sourceDir ".data/packages.yaml" | include | fromYaml -}}
{{- range $packages -}}
{{- if hasKey . "curl-sh" -}}
{{- /* Create a dictionary to hold the normalized command values */ -}}
{{- $vars := dict "url" "" "shell" "sh" -}}
{{- $cmdConfig := index . "curl-sh" -}}

{{- /* Check if the config is a map (object) or a simple string */ -}}
{{- if kindIs "map" $cmdConfig -}}
    {{- $_ := set $vars "url" $cmdConfig.url -}}
    {{- if hasKey $cmdConfig "shell" }}{{ $_ := set $vars "shell" $cmdConfig.shell }}{{ end -}}
{{- else -}}
    {{- $_ := set $vars "url" $cmdConfig -}}
{{- end -}}

echo "Installing '{{ .name }}' via curl-sh..."
if curl -fsSL "{{ $vars.url }}" | {{ $vars.shell }} -; then
    echo "'{{ .name }}' installed successfully."
else
    # Capture the exit code from the pipe
    exit_code=${PIPESTATUS[1]}
    echo "Error: Failed to install '{{ .name }}' (Exit code: $exit_code)." >&2
fi
echo ""
{{ end -}}
{{ end }}